#!/bin/sh /etc/rc.common
#MTK-Wi-Fi

START=99

start() {
	/sbin/mtk-wifi.sh &
	if grep -q 'processor.*: 2' /proc/cpuinfo; then
		mask=4
	elif grep -q 'processor.*: 1' /proc/cpuinfo; then
		mask=2
	else
		return
	fi

	for irq in $(grep -E "mt|ra" /proc/interrupts | cut -d: -f1 | sed 's, *,,'); do
		echo "$mask" > "/proc/irq/$irq/smp_affinity"
		[ $mask = 4 ] && mask=8
	done

	[ -e "/sys/class/net/eth0/queues/rx-0/rps_cpus" ] && echo "6" > "/sys/class/net/eth0/queues/rx-0/rps_cpus"
	[ -e "/sys/class/net/ra0/queues/rx-0/rps_cpus" ] && echo "6" > "/sys/class/net/ra0/queues/rx-0/rps_cpus"
	[ -e "/sys/class/net/rai0/queues/rx-0/rps_cpus" ] && echo "6" > "/sys/class/net/rai0/queues/rx-0/rps_cpus"
	[ -e "/sys/class/net/rax0/queues/rx-0/rps_cpus" ] && echo "6" > "/sys/class/net/rax0/queues/rx-0/rps_cpus"
	[ -e "/sys/class/net/apcli0/queues/rx-0/rps_cpus" ] && echo "6" > "/sys/class/net/apcli0/queues/rx-0/rps_cpus"
	[ -e "/sys/class/net/apclix0/queues/rx-0/rps_cpus" ] && echo "6" > "/sys/class/net/apclix0/queues/rx-0/rps_cpus"
	[ -e "/sys/class/net/apclii0/queues/rx-0/rps_cpus" ] && echo "6" > "/sys/class/net/apclii0/queues/rx-0/rps_cpus"
	[ -e "/sys/class/net/phy0-ap0/queues/rx-0/rps_cpus" ] && echo "6" > "/sys/class/net/phy0-ap0/queues/rx-0/rps_cpus"
	[ -e "/sys/class/net/phy1-ap0/queues/rx-0/rps_cpus" ] && echo "6" > "/sys/class/net/phy1-ap0/queues/rx-0/rps_cpus"
	[ -e "/sys/class/net/phy0-sta0/queues/rx-0/rps_cpus" ] && echo "6" > "/sys/class/net/phy0-sta0/queues/rx-0/rps_cpus"
	[ -e "/sys/class/net/phy1-sta0/queues/rx-0/rps_cpus" ] && echo "6" > "/sys/class/net/phy1-sta0/queues/rx-0/rps_cpus"
	echo "8" > "/proc/irq/23/smp_affinity"
	echo "8" > "/proc/irq/24/smp_affinity"
}
